##プロモーション表示(インベントリ)のWorkflow

###プロモーション表示のSequence

インベントリゲームとしてプロモーションを表示するためのSequenceは、次のとおりです。


![プロモーション表示Sequence](https://raw.githubusercontent.com/ToastAnalytics/ToastAnalytics_JA/master/docs/Developer/images/promotion_impression_sequence.png)
[プロモーション表示Sequence]


###ゲームクライアント側の開発作業

####1.プロモーションアイコンの表示

まずSDKが提供する初期化関数と、ユーザーID設定関数を呼び出します。
プロモーションアイコンを表示するためには、現在プロモーションが表示できるステータスなのかを確認する必要があり、 isPROMOTIONAvailable関数を呼び出すことで、そのステータスを確認することができます。
ステータス照会関数がtrueを返したらプロモーション表示が可能なステータスであるため、適切な位置にボタンを作成します。ボタンに使うイメージのパスは、getPROMOTIONButtonImagePatの関数から得られます。
ボタンクリック時、プロモーションボードが表示されるようにするためには、クライアントでクリックイベントに対する処理を行う必要があり、クリックイベント発生時にlaunchPROMOTIONPage関数を呼び出すと、プロモーションボードが表示されます。

####2.リワードの処理

(すでにAnalytics In App Campaignに関するリワードの処理が実装されている場合は、追加作業は必要ありません。)
ユーザーがプロモーションアイコンをクリックすると、1日1回に限り、リワードが付与されます。
リワードが発生した場合、SDKはクライアント側にonMissionCompleteというCallback関数を呼び出し、ミッションKeyとミッションValue値を送ります。
この値はゲームサーバーでリワードの処理を行うために必要であるため、必ずゲームサーバー側に渡す必要があり、渡し方については、ゲーム内で自由に実装してください。

```
* PROMOTIONで指定されたミッション情報の場合、ゲームミッションとの区別のため、ミッションKeyの値は「*」で始まります。
```
 
###ゲームサーバー側の開発作業

####1.リワードの処理


プロモーションに係わるゲームサーバー側の主な作業は、リワードの処理です。
ゲームサーバーは、次の場合に、PROMOTION Serverからcheck-mission APIを呼び出し、ミッションの達成有無を確認する必要があります。
プロモーションの実施中に、ミッション設定と係わるFactor(Level、Ranking、ゲームの起動回数など、ゲームで指定された値)に変化がある場合
PROMOTIONで予め指定されたミッション情報を受けた場合(例：アプリインストールのミション、プロモーションアイコンのクリックミッション)

```
* PROMOTIONで指定されたミッション情報の場合、ゲームミッションと区別するため、ミッションKeyの値は「*」で始まります。
```
 
PROMOTION Serverにcheck-mission APIを呼び出した時、リワードがある場合にはリワードコードが送信され、ゲームクライアントにリワードを送ります。この処理はゲームで実装します。
 (回答データのrewardListフィールドを通じて、リワード情報が送信されます。1回のみ。)

ゲームサーバーが呼び出す必要があるミッションクリア通知APIのフォーマットは、次の通りです。


```json
Host:https://api-campaign-analytics.cloud.toast.com
POST /campaign/v1/server/check-mission
Content-Type:application/json

{
  "header":
  {
    "transactionId" :92348729384729、
  },
  "userId" :"23948234",
  "appId" :"13",
  "missionKey" :"LEVEL",
  "missionValue" :10
}
```

| 名前　　　　　　　　　　　| 資料型　　　　　　　　　　| 説明　　　　　　　|
|-------------|----------------|----------------|
| transactionId | int64 | リクエストの追跡のためにロギング時に用いられますが、必須値ではありません。ここに入力された値は、レスポンス・データのtransactionIdフィールドに適用され、返却されます。|
| userId | string | ゲームで提供されるユーザーのunique ID |
| appId | String | アプリ登録時に割り当てられるアプリ番号。[アプリ設定] > [Appkey]の値を入力してください。|
| missionKey | string | 特定のアクションを定義するKeyの値またはonMissionComplete(SDK)を通じて送られた値。[アプリ設定] > [キャンペーン設定] > [ミッションおよびリワードアイテム設定]で登録したミッションKeyの値 |
| missionValue | int64 | missionKeyに対するValue|

```json
HTTP/1.1 200 OK

{
  "header" :
  {
    "transactionId" :92348729384729,
    "isSuccessful" :"false",
    "resultcode" :9001,
    "resultMessages" :["Invalid input parameter.","..."],
    "serviceCode" :10
  },
  "rewardList" :[
    {
      "campaignId" :7,
      "promoDateBegin" :"2014-10-10 00:00:00",
      "promoDateEnd" :"2014-10-11 00:00:00",
      "rewardDateBegin" :"2014-10-10 00:00:00",
      "rewardDateEnd" :"2014-10-12 00:00:00",
      "rewardCode" :"gem",
      "rewardValue" :100
    },
    ...
  ]
}
```

| 名前　　　| 資料型　　　| 説明　　|
|--------|----------|---------|
| transactionId | int64 | リクエスト時に送られたtransactionIdに同じ設定を適用する。|
| isSuccessful | string | ミッションの達成有無を設定する。(達成:"true"、未達成:"false") |
| resultCode | int | リターンコードを作成する。(達成の場合は0) |
| resultMessages | vector<string> | 複数のリターンメッセージを作成する。|
| serviceCode | int | サービスコード |
| campaignId | int | リワードのあるキャンペーン番号 |
| promoDateBegin | stringキャンペーンの開始時刻 (UTC+0 基準) |
| promoDateEnd | string | キャンペーンの終了時刻 (UTC+0 基準) |
| rewardDateBegin | string | リワードの開始時刻 (UTC+0 基準) |
| rewardDateEnd | string | リワードの終了時刻 (UTC+0 基準) |
| rewardCode | string | リワードコード |
| rewardValue | int | リワードの値 |

##プロモーションのWorkflow

###プロモーションのSequence

対象ゲームとして、プロモーションの処理Sequenceは、次の通りです。


![プロモーション対象Sequence](https://raw.githubusercontent.com/ToastAnalytics/ToastAnalytics_JA/master/docs/Developer/images/promotion_target_sequence.png)
[プロモーション対象Sequence]


###ゲームクライアントの開発作業

####リワードの処理

(すでにAnalytics In App Campaignに関するリワードの処理が実装されている場合、追加作業は必要ありません。)
プロモーション対象ゲームにおいて、クライアントで必要な作業は、ミッション送信とリワードの処理です。
リワードが発生した場合、SDKではクライアント側にonMissionCompleteというCallback関数を呼び出し、ミッションKeyとミッションValue値を送ります。
この値は、リワードの処理のためにゲームサーバーで必要なので、必ずゲームサーバー側に渡す必要があります。渡し方については、ゲーム内で自由に実装してください。

```
* PROMOTIONで指定されたミッション情報の場合、ゲームミッションとの区別のため、ミッションKeyの値は「*」で始まります。
```

###ゲームサーバー側の開発作業

####リワードの処理

プロモーションに関わるゲームサーバーの主な作業はリワードの処理です。
ゲームサーバーは次の場合に対し、PROMOTION Serverにcheck-mission APIを呼び出しミッションの達成有無を確認しなければなりません。
プロモーション実施中に、ミッションの設定に関わるFactor(Level、Ranking、ゲーム実施回数などゲームで指定した値段)の変化がある場合
PROMOTIONであらかじめ指定されたミッション情報を受信した場合(例　アプリインストールミション、プロモーションアイコンのクリックミッション)

```
* PROMOTIONで指定されたミッション情報の場合、ゲームミッションとの区別のため、ミッションKeyの値が「*」で始まります。
```

PROMOTION Serverに check-mission APIを呼び出した時、リワードがある場合にはリワードコードが送られ、確認後ゲームクライアントにリワードを送ります。この処理はゲームで実装します。ゲームサーバーが呼び出す必要があるミッション達成通知のAPIは、プロモーション表示(インベントリ)Workflowのゲームサーバーリワードの処理のところと同じです。
