#はじめに

Analyticsでキャンペーンとはインハウス・キャンペーン（inhouse campaign)のことを言います。これは、アプリ内のポップアップやバナーを通じてユーザーにイベント（ミッション)を表示し、利用者がイベントを実施した場合、リワードを付与できる機能を提供しています。
Toast Analyticsが提供するインハウス・キャンペーンの機能は、キャンペーンの実施によるユーザーおよび売上の増加に伴う成果分析の結果指標を自動的に確認できます。また、キャンペーンの効率を最大化するために、キャンペーンの目的に合ったターゲットを絞ることができます。

この機能を使うためには、以下のような追加作業が必要です。本ドキュメントは、それらの作業の詳細について説明しています。
1.キャンペーンの表示およびリワードの処理のために、アプリクライアントにToast Analytics SDKの適用が必要です。
2.ユーザーのミッションの達成通知およびリワードの確認のために、ゲームサーバー（またはアプリケーションサーバーとキャンペーンサーバー間の通信が必要です。)

##用語説明
キャンペーンサービスでは、内部的に以下の用語が使われます。

|用語|説明|
|---|---|
|（インハウス)キャンペーン|　アプリの中でポップアップやバナーを通じてユーザーにイベント（ミッション)を表示し、ユーザーがミッションを達成した場合、リワードを付与できるToast Analyticsの機能|
|（キャンペーン)ミッション|　キャンペーンのリワード提供のためにユーザーが達成すべき目標|
|カスタマイズデータ|	カスタマイズデータ|
|（キャンペーン)リワード|　ユーザーがミッションを達成した場合、提供するアプリ内のゲーム内通貨|

##重要な連動項目における説明
Campaignサービスの動作フローは次の図のとおりです。
![Project Sett](https://raw.githubusercontent.com/ToastAnalytics/ToastAnalytics_JA/master/docs/Developer/images/image003.png)
[図1 サービスの動作フロー]

以下に取り上げられる内容は、連動時に必要な重要項目について簡単に説明したものです。このドキュメントの後半で、その詳細を確認できます。
###1.TOAST Analytics SDKの適用
Analytics Campaignの機能を使うためには、Toast Analytics SDKをアプリに適用する必要があります。
TOAST Analytics SDKの適用に関する内容は、このドキュメントの後半で確認できます。また、別途提供されるToast Analytics APIのリファレンスドキュメントにもその内容が取り上げられています。

###2.キャンペーンの設定
新規キャンペーンを直接作成することもできますが、テンプレートを使うことでより早く簡単に効率の良いキャンペーンを作ることができます。 
Toast Analyticsのウェブサイトにある「キャンペーンの実施」で新しいキャンペーンを登録することができます。これに関する詳細は、該当するページの右上にある「ページガイド」に取り上げられています。

###3.テスト端末の登録
キャンペーンが一般ユーザーに表示される前に、キャンペーンの正常な表示および動作の可否を確認するためにテストを行う必要があります。テストを実施するためには、Toast Analytics SDKでDevice IDおよびDevice Tokenを獲得してからテスト端末を登録します。
Analyticsのウェブサイトの「アプリの設定ボタン」 > 「キャンペーンの設定」 > 「テストデバイスの設定」でテスト端末を登録することができます。

###4.キャンペーンのテストの実施
テスト端末の登録が正常に終わると、Toast Analyticsのウェブサイトの「キャンペーン実施」> 「キャンペーンリスト」 > 「テストボタン」をクリックすることでテストが進みます。

###5.キャンペーンの動作確認
テスト端末でキャンペーンが正常に動作するか確認します。そのためには、次に取り上げられる4ステージにおける進捗状況を確認する必要があります。各ステージの詳細はToast Analyticsのウェブサイトの右上にある「ページガイド」で確認できます。
但し、ミッションの達成およびリワードの検証は、それらの項目における設定が完了しているキャンペーンのみ該当します。
- 表示：キャンペーン情報がテスト端末に正常に受信され、キャンペーンを表示する準備が完了した状態
- 実施：テスト端末にバナーまたはポップアップが表示され、キャンペーンへの参加を開始した状態
- ミッション：ゲームサーバーからキャッシュサーバーにミッションデータの送信が正常に終了した状態
- リワード：キャンペーンサーバーからゲームサーバーへの情報転送が正常に終了した状態

###6.キャンペーンの表示
キャンペーンテストが全て完了すると、外部のユーザーがアクセスできるようにキャンペーンを開始することができます。キャンペーンの開始後、アプリがキャンペーンの表示場所（キャンペーン設定>表示場所の設定を参照)に達した場合、キャンペーンが表示されます。

###7.ミッションの完了およびリワードの付与処理
キャンペーンのミッションを達成するために、ユーザーがある特定の行動（例：レベル、ランキングの変化など)をした場合、ゲームサーバーは、キャンペーンサーバーのAPI（check mission)を呼び出し、ミッションの達成有無を確認できます。 
ミッション達成後は、キャンペーンサーバーからゲームサーバーにリワード情報が送られます。ゲームサーバーは、この情報に基づいてクライアントにリワードを付与します。

#ゲームクライアントの適用

Campaignシステムの動作フローは次の図2のとおりです。
![Project Sett](https://raw.githubusercontent.com/ToastAnalytics/ToastAnalytics_JA/master/docs/Developer/images/image004.png)

[図2 システムの動作フロー]

##ゲームクライアント

概念の理解を助けるためにJava Codeを用いて説明します。詳細は、プラットフォームごとに提供されるProgramming Guideをご参照下さい。


##ゲームサーバー

###1.ゲームサーバーの認証
キャンペーンサーバーへのアクセスにおける制限ポリシーがACLから他の方式に変更される予定です。 
現在は、外部からの流入についてACLによる制限を設けていません。
今後、認証関連ポリシーが決まった場合、追加作業が必要となる可能性もあります。

###2.リワードの処理
キャンペーンに関するゲームサーバーの主な作業はリワードの処理です。
ゲームサーバーは、次のような場合に対し、キャンペーンサーバーでcheck-mission APIを呼び出し、ミッションの達成有無を確認する必要があります。
- キャンペーンが進行中の場合、 ミッション設定に関するFactor（Level、Ranking、ゲームプレイ回数など、ゲームで指定した値)に変化がある場合

キャンペーンサーバーにcheck-mission APIを呼び出した際、リワードがある場合には、リワードコードが送られます。その場合、ゲームクライアントにリワードを送信します。上記の処理はゲームで実装されます。(レスポンスデータのrewardListフィールドによりリワード情報が送信されます。（1回のみ)
注意：リワードがない場合も、rewardListフィールドは送信されます。（null値) 

ゲームサーバーの呼び出すミッション達成の通知APIフォーマットは次のとおりです。

###3.リクエストの例
```json
Host:https://api-campaign-analytics.cloud.toast.com
POST /campaign/v1/server/check-mission
Content-Type:application/json
{
    "header":
    {
	    "transactionId" : 92348729384729,
    },
    "userId" : "23948234",
    "appId" : "13",
    "missionKey" : "LEVEL",
    "missionValue" : 10
}
```

###4.リクエスト・パラメータ
リクエスト・パラメータ

|名前|資料のタイプ|説明|
|---|---|---|
|transactionId|	int64|	リクエストの追跡のためにロギング時に用いられますが、必須値ではありません。ここに入力された値は、レスポンスデータのtransactionIdフィールドに適用され、返却されます。
|userId|	string|	ゲームで提供されるunique ID|
|appId|	string|　アプリ登録時に割り当てられたアプリ番号。Analyticsサイトの「アプリ設定」> 「AppKey」の値を入力してください。|
|missionKey|	string|	特定のアクションを定義するKeyまたはonMissionComplete（SDK)を通じて送られた値。Analytics サイトの「アプリ設定」> [キャンペーン設定]> [ミッションおよびリワードアイテムの設定」で登録したミッションのkey|
|missionValue|	int64|	missionKeyに対するValue|

###5.レスポンスの例
```json
HTTP/1.1 200 OK
{
    "header" :
    {
        "transactionId" : 92348729384729,
        "isSuccessful" : "false",
        "resultcode" : 9001,
        "resultMessages" : ["Invalid input parameter.", "..."],
        "serviceCode" : 10
    },
    "rewardList" : [
        {
            "campaignId" : 7,
            "promoDateBegin" : "2014-10-10 00:00:00",
            "promoDateEnd" : "2014-10-11 00:00:00",
            "rewardDateBegin" : "2014-10-10 00:00:00",
            "rewardDateEnd" : "2014-10-12 00:00:00",
            "rewardCode" : "gem",
            "rewardValue" : 100
        },
        ...
    ]
}
```

###6.レスポンスデータ
レスポンスデータ

|名前|資料のタイプ|説明|
|---|---|---|
|transactionId	|int64|	リクエスト時に送られたtransactionIdに同じ設定を適用する。|
|isSuccessful	|string|	成功可否を設定する。（成功:"true", 失敗:"false")|
|resultCode	|int|	リターンコードを作成する。（成功した場合 0)|
|resultMessages	|vector<string>|	複数のリターンメッセージを作成する。|
|serviceCode	|int|	サービスコード|
|campaignId	|int|	リワードのあるキャンペーンの番号|
|promoDateBegin	|string|	キャンペーンの開始時刻（UTC+0を基準とする)|
|promoDateEnd	|string|	キャンペーンの終了時刻（UTC+0を基準とする)|
|rewardDateBegin	|string|	リワードの開始時刻（UTC+0を基準とする)|
|rewardDateEnd	|string|	リワードの終了時刻（UTC+0を基準とする)|
|rewardCode	|string|	リワードコード|
|rewardValue	|int|	リワードの値|
